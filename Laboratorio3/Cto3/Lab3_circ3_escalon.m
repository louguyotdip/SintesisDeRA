close all; clear all; clc

pkg load control
pkg load symbolic
%graphics_toolkit("gnuplot");
s = tf('s');

% ────────────────────────────────────────────────
% Parámetros principales (sin compensación)
% ────────────────────────────────────────────────

R1 = 45;
R2 = 925;

% Término T1 (complejo, con muchos polos)
T1 = - ( ...
    (0.1 * (1/R1 + 1/R2) * 2.37e11) + ...
    (1/R2) * 2.37e6 * (1 + s/(2*pi*10)) * (1 + s/(2*pi*5060000)) ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s/(2*pi*14000)) * ...
    (1 + s/(2*pi*82300000)) ...
);

% Término T2 (simplificado)
T2 = - ( ...
    0.1 * (1 + R2/R1) * 1e5 ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s * R2 * 4.8e-12) ...
);

% Ganancias abiertas A1 y A2
A1 = ( ...
    (1/R1 + 1/R2) * 2.37e11 ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s/(2*pi*14000)) * ...
    (1 + s/(2*pi*82300000)) ...
);

A2 = ( ...
    (1 + R2/R1) * 1e5 ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s * R2 * 4.8e-12) ...
);

% Modelos cerrados
Avf1 = A1 / (1 - T1);      % Modelo completo
Avf2 = A2 / (1 - T2);      % Modelo simplificado

% ────────────────────────────────────────────────
% Parte compensada con red pasiva (R1P, R2P, P)
% ────────────────────────────────────────────────

R1P = 23;
R2P = 925;

% Término P (red pasiva de compensación)
P = (1 + s/(2*pi*5060000)) / (2 * (1 + s/(2*pi*10120000)));

T1P = -P * ( ...
    0.1 * (1/R1P + 1/R2P) * 2.37e11 ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s/(2*pi*14000)) * ...
    (1 + s/(2*pi*82300000)) ...
) - ( ...
    (1/R2P) * 2.37e6 ...
) / ( ...
    (1 + s/(2*pi*14000)) * ...
    (1 + s/(2*pi*82300000)) ...
);

T2P = -P * ( ...
    0.1 * (1 + R2P/R1P) * 1e5 ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s * R2P * 4.8e-12) ...
);

A1P = P * ( ...
    (1/R1P + 1/R2P) * 2.37e11 ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s/(2*pi*14000)) * ...
    (1 + s/(2*pi*82300000)) ...
);

A2P = P * ( ...
    (1 + R2P/R1P) * 1e5 ...
) / ( ...
    (1 + s/(2*pi*10)) * ...
    (1 + s/(2*pi*5060000)) * ...
    (1 + s * R2P * 4.8e-12) ...
);

Avf1p = A1P / (1 - T1P);     % Modelo compensado completo

figure('Position', [100 100 900 600]);
step(Avf1, Avf1p);
grid on;
xlim([0 0.0000008]);

disp('Terminado')
